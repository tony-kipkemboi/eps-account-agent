# Databricks Asset Bundle Configuration
# Deploy with: databricks bundle deploy --target <environment>
# Docs: https://docs.databricks.com/en/dev-tools/bundles/index.html

bundle:
  name: eps_account_agent

# Variables that can be overridden per environment
variables:
  catalog:
    default: eps_intelligence
  schema:
    default: agents
  model_name:
    default: eps_account_agent
  secret_scope:
    default: eps_agent_scope
  llm_endpoint:
    default: databricks-gpt-5-mini

# Workspace settings
workspace:
  host: https://dbc-4c764595-9799.cloud.databricks.com

# Include agent code
include:
  - ./databricks/oai_reponses_agent/*.py

# Deployment targets (environments)
targets:
  # Development - for testing
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/.bundle/${bundle.name}/dev
    variables:
      catalog: eps_intelligence_dev
      schema: agents

  # Staging - for UAT
  staging:
    workspace:
      root_path: /Workspace/Shared/.bundle/${bundle.name}/staging
    variables:
      catalog: eps_intelligence_staging

  # Production
  prod:
    mode: production
    workspace:
      root_path: /Workspace/Shared/.bundle/${bundle.name}/prod
    variables:
      catalog: eps_intelligence

# Resources to deploy
resources:
  # Register the model to Unity Catalog
  models:
    eps_agent_model:
      name: ${var.catalog}.${var.schema}.${var.model_name}
      description: "EPS Account Intelligence Agent - searches Glean for account information"
      tags:
        - key: project
          value: eps_intelligence
        - key: team
          value: eps

  # Model Serving Endpoint
  serving_endpoints:
    eps_agent_endpoint:
      name: agents_${var.catalog}-${var.schema}-${var.model_name}
      config:
        served_entities:
          - name: eps_agent
            entity_name: ${var.catalog}.${var.schema}.${var.model_name}
            entity_version: "1"  # Will be updated by CI/CD
            workload_size: Small
            scale_to_zero_enabled: true
        auto_capture_config:
          catalog_name: ${var.catalog}
          schema_name: ${var.schema}
          table_name_prefix: agent_logs
      tags:
        - key: project
          value: eps_intelligence

